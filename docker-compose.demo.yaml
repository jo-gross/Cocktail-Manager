services:
  postgres:
    image: postgres:latest
    container_name: cocktail-recipe-postgres-demo
    ports:
      - '5433:5432'  # Different port to avoid conflicts
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=cocktail_recipe_demo
    volumes:
      - postgres_data_demo:/var/lib/postgresql/data
    networks:
      - cocktail-recipe-demo-network
    restart: unless-stopped

  cocktail-manager-demo:
    depends_on:
      - postgres
      - chromium-service-demo
    links:
      - postgres
      - chromium-service-demo
    # Use pre-built image from GitHub Container Registry
    # To build locally, uncomment the build section and comment out the image line
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     DEPLOYMENT: 'demo'
    #     DEMO_MODE: 'true'
    image: ghcr.io/jo-gross/cocktail-manager-demo:latest
    container_name: cocktail-manager-demo
    ports:
      - '3001:3000'  # Different port to avoid conflicts
    env_file:
      - .env  # Optional: separate env file for demo
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/cocktail_recipe_demo
      - CHROMIUM_HOST=chromium-service-demo
      - DEMO_MODE=true
      - DEMO_WORKSPACE_CONFIG_PATH=/app/config/demo-workspace-config.json
      - DEMO_TTL_HOURS=24
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-demo-secret-change-in-production}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3001}
    volumes:
      - ./config:/app/config:ro  # Mount config directory
    networks:
      - cocktail-recipe-demo-network
    restart: unless-stopped

  chromium-service-demo:
    image: eu.gcr.io/zenika-hub/alpine-chrome:latest
    container_name: chromium-service-demo
    networks:
      - cocktail-recipe-demo-network
    command:
      - chromium-browser
      - --headless
      - --disable-gpu
      - --no-sandbox
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
    ports:
      - '9223:9222'  # Different port to avoid conflicts
    restart: unless-stopped

  cleanup-cron:
    image: ghcr.io/jo-gross/cocktail-manager-demo:latest
    container_name: cocktail-manager-demo-cleanup
    depends_on:
      - postgres
      - cocktail-manager-demo
    environment:
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/cocktail_recipe_demo
    networks:
      - cocktail-recipe-demo-network
    # Use the same image but run cleanup script via cron
    # Runs every hour at minute 0 (0 * * * *)
    entrypoint: /bin/sh
    command: >
      -c "
      echo '0 * * * * cd /app && corepack enable pnpm && corepack prepare pnpm@9.15.4 --activate && node scripts/cleanup-demo-workspaces.js >> /var/log/cleanup.log 2>&1' | crontab - &&
      crond -f -l 2
      "
    volumes:
      - cleanup_logs:/var/log
    restart: unless-stopped

networks:
  cocktail-recipe-demo-network:
    driver: bridge

volumes:
  postgres_data_demo:
  cleanup_logs:
